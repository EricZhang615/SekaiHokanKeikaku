# MySQL 八股

## 基础

### 执行一条 select 语句，期间发生了什么

![](https://cdn.xiaolincoding.com/gh/xiaolincoder/mysql/sql%E6%89%A7%E8%A1%8C%E8%BF%87%E7%A8%8B/mysql%E6%9F%A5%E8%AF%A2%E6%B5%81%E7%A8%8B.png)

#### 1. 连接器

建立TCP连接

长连接 / 短连接

管理连接
- 连接数上限
- 连接时间上限

校验身份

#### 2. 查询缓存

**server层缓存， 不是引擎的buffer pool**

MySQL 8.0 版本直接将查询缓存删掉了

#### 3. 解析 SQL

##### 解析器

1. 词法分析 得关键字
2. 语法分析
   - 只检查语法、构建语法树
   - 不会检查字段是否存在

#### 4. 执行 SQL

每条 SELECT 查询语句流程主要可以分为下面这三个阶段：

- prepare
  - 检查 SQL 查询语句中的表或者字段是否存在；
  - 将 select * 中的 * 符号，扩展为表上的所有列；
- optimize
  - 负责将 SQL 查询语句的执行方案确定下来（选择索引），选择查询成本最小的执行计划
- execute
  - 主键索引查询
    - 执行器调用引擎索引查询接口，传递条件要求定位
    - 引擎通过主键索引的 B+ 树定位记录
    - 执行器判断是否符合条件 不符合则跳过
    - 执行器查询的过程是一个 while 循环，所以还会再查一次；因为const类型，永远返回-1，退出循环
  - 全表扫描
    - 执行器调用引擎全扫描接口，要求读第一条记录
    - 执行器判断条件，是则直接发给客户端，否则跳过（读一条发一条）
    - 执行器查询的过程是一个 while 循环，所以还会再查一次；因为优化器选择访问类型为 all ，read_record 函数指针指向的还是 InnoDB 引擎全扫描的接口，继续循环
    - 引擎向执行器返回读取完毕
    - 执行器收到查询完毕信息，退出循环
  - 索引下推
    联合索引当遇到范围查询就会停止匹配
    - 执行器调用引擎接口定位满足条件的第一条二级索引记录
    - 引擎定位到二级索引后，先**不回表**，判断该索引中包含的列的条件是否成立。如果条件不成立，则直接跳过该二级索引。如果成立，则执行回表操作，将完成记录返回给执行器。
    - server层判断其他条件是否成绩
    - 循环

## 索引

